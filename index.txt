Trae, buatkan sistem lengkap anti-limit 429 untuk Laravel berdasarkan spesifikasi berikut.
Sistem ini digunakan untuk generate VO (Voice Over) menggunakan Gemini TTS.
Semua logic wajib menggunakan tabel configapikey berikut, tanpa ubah 1 kolom pun:

CREATE TABLE IF NOT EXISTS `configapikey` (
  `ApiKeyId` int(11) NOT NULL,
  `JenisApiKey` varchar(50),
  `Project` varchar(200),
  `ApiKey` varchar(500),
  `DefaultVoiceId` varchar(50),
  `Model` varchar(100) NOT NULL DEFAULT 'gemini-2.0-flash',
  `RpmLimit` int(11) NOT NULL DEFAULT 60,
  `RpdLimit` int(11) NOT NULL DEFAULT 5000,
  `MinuteCount` int(11) NOT NULL DEFAULT 0,
  `DayCount` int(11) NOT NULL DEFAULT 0,
  `MinuteWindowEndPT` datetime NOT NULL DEFAULT current_timestamp(),
  `DayWindowEndPT` datetime NOT NULL DEFAULT current_timestamp(),
  `Status` varchar(20) NOT NULL DEFAULT 'AVAILABLE',
  `CooldownUntilPT` datetime DEFAULT NULL,
  `UpdatedAt` datetime NOT NULL DEFAULT current_timestamp(),
  `CreatedAt` datetime NOT NULL DEFAULT current_timestamp(),
  PRIMARY KEY (`ApiKeyId`)
);


Tujuan utama:

Tidak ada lagi error 429

API key dipakai secara aman & bergiliran

User bisa request VO banyak tanpa mematikan API key

Sistem scalable dan stabil seperti CapCut/Canva/ElevenLabs

üéØ TASK UTAMA UNTUK TRAE
‚úî 1. Buat 3 file utama:
(A) Service:

app/Services/GeminiTtsService.php
‚Üí bertugas memanggil Gemini TTS dengan throttle & retry.

(B) API Key Selector:

app/Services/ApiKeySelector.php
‚Üí memilih API key terbaik sesuai tabel configapikey.

(C) Queue Job:

app/Jobs/GenerateVoJob.php
‚Üí generate VO via queue, update tabel, simpan file.

üß© DETAIL REQUIREMENTS
1. SYSTEM FLOW (WAJIB IKUTI)
End-to-End Flow
Client ‚Üí POST /generate-vo
Server ‚Üí simpan job database
Server ‚Üí masukkan ke queue "tts"
Worker ‚Üí pilih API key terbaik
Worker ‚Üí pilih model TTS (fallback)
Worker ‚Üí throttle (1 detik per request per key)
Worker ‚Üí call Gemini TTS
Worker ‚Üí update quota API key
Worker ‚Üí simpan file
Worker ‚Üí ubah status job
Client ‚Üí polling /status/{job_id}

2. LOGIC PEMILIHAN API KEY (WAJIB IKUTI)
Query harus seperti berikut:
SELECT *
FROM configapikey
WHERE Status = 'AVAILABLE'
  AND MinuteCount < RpmLimit
  AND DayCount < RpdLimit
  AND (CooldownUntilPT IS NULL OR CooldownUntilPT < NOW())
ORDER BY MinuteCount ASC, DayCount ASC
FOR UPDATE
LIMIT 1;


Trae harus implementasikan ini di Laravel Eloquent:

$key = ConfigApiKey::where('Status', 'AVAILABLE')
    ->where('MinuteCount', '<', DB::raw('RpmLimit'))
    ->where('DayCount', '<', DB::raw('RpdLimit'))
    ->where(function ($q) {
        $q->whereNull('CooldownUntilPT')
          ->orWhere('CooldownUntilPT', '<', now());
    })
    ->orderBy('MinuteCount', 'asc')
    ->orderBy('DayCount', 'asc')
    ->lockForUpdate()
    ->first();

3. RESET WINDOW (PAKAI KOLOM YANG ADA)

Sebelum pakai API key, periksa:

Reset window menit
if ($key->MinuteWindowEndPT < now()) {
    $key->MinuteCount = 0;
    $key->MinuteWindowEndPT = now()->addMinute();
}

Reset window hari
if ($key->DayWindowEndPT < now()) {
    $key->DayCount = 0;
    $key->DayWindowEndPT = now()->addDay();
}

4. MODEL TTS YANG VALID

Karena hanya ini yang support VO:

gemini-2.5-flash-preview-tts
gemini-2.5-pro-preview-tts


Jika Model dari tabel bukan salah satu di atas ‚Üí fallback otomatis ke:

gemini-2.5-flash-preview-tts

5. CALL GEMINI HARUS ADA THROTTLE

Setiap request harus ditahan minimal:

1.1 detik per API key


Implementasi:

usleep(1100 * 1000);

6. HANDLE ERROR 429 (WAJIB IKUTI)

Jika Gemini lempar error 429:

Ubah status API key:

$key->Status = 'KENA LIMIT';
$key->CooldownUntilPT = now()->addSeconds(5);
$key->save();


Release job agar dicoba ulang:

return $this->release(3);

7. UPDATE QUOTA API KEY

Setiap sukses:

$key->MinuteCount += 1;
$key->DayCount += 1;
$key->UpdatedAt = now();
$key->save();

8. SIMPAN HASIL VO

Taruh di:

storage/app/public/vo/{job_id}.mp3

Storage::disk('public')->put("vo/{$job->id}.mp3", $audioData);

9. UPDATE STATUS JOB

Set:

status = done

path = vo/xxx.mp3

10. BUATKAN ENDPOINT
POST /generate-vo

Input:

text, voice, speed

GET /vo-status/{job_id}

Return:

status
file_url (jika done)

üéÅ FILE-FILE YANG HARUS TRAE BUAT
‚úî app/Services/ApiKeySelector.php

Select key

Reset window

Apply lockForUpdate

‚úî app/Services/GeminiTtsService.php

Throttle

Error handling

Retry

TTS call

‚úî app/Jobs/GenerateVoJob.php

Worker logic keseluruhan

‚úî Controller:

VoiceOverController.php

‚úî Migration untuk tabel jobs VO

(boleh bernama voice_jobs)

üìå CATATAN PENTING

Jangan ubah struktur tabel configapikey

Gunakan queue driver database/redis

Semua pemanggilan Gemini harus lewat worker, bukan controller

Tidak boleh ada paralel request untuk 1 API key

üëá Selesai. Jalankan sesuai spesifikasi di atas.
    // =========================
    // ===== VO ENDPOINTS  =====
    // =========================

    // GET sisa VO (detik & menit)
    [HttpGet, Route("{orderId}/vo")]
    public IHttpActionResult GetVoQuota(string orderId)
    {
        try
        {
            var cs = System.Configuration.ConfigurationManager
                       .ConnectionStrings["MaximalCuanLicenseDBConnectionString"].ConnectionString;

            using (var ctx = new MaximalCuanDataContext(cs))
            {
                var lic = ctx.Licenses.SingleOrDefault(x => x.OrderId == orderId);
                if (lic == null) return NotFound();

                var sec = lic.VoSecondsRemaining;
                return Ok(new
                {
                    orderId,
                    seconds = sec,
                    minutes = (int)Math.Ceiling(sec / 60.0)
                });
            }
        }
        catch (Exception ex)
        {
            LogError("GetVoQuota failed", ex);
            return InternalServerError(ex);
        }
    }

    public class VoTopupDto { public int addSeconds { get; set; } }

    // TOP-UP detik VO (lifetime)
    [HttpPost, Route("{orderId}/vo/topup")]
    public IHttpActionResult TopupVo(string orderId, [FromBody] VoTopupDto dto)
    {
        if (dto == null || dto.addSeconds <= 0) return BadRequest("addSeconds must be > 0");

        try
        {
            var cs = System.Configuration.ConfigurationManager
                       .ConnectionStrings["MaximalCuanLicenseDBConnectionString"].ConnectionString;

            using (var ctx = new MaximalCuanDataContext(cs))
            {
                var lic = ctx.Licenses.SingleOrDefault(x => x.OrderId == orderId);
                if (lic == null) return NotFound();

                lic.VoSecondsRemaining = (lic.VoSecondsRemaining) + dto.addSeconds;
                ctx.SubmitChanges();

                var sec = lic.VoSecondsRemaining;
                return Ok(new
                {
                    ok = true,
                    orderId,
                    seconds_remaining = sec,
                    minutes_remaining = (int)Math.Ceiling(sec / 60.0)
                });
            }
        }
        catch (Exception ex)
        {
            LogError("TopupVo failed", ex);
            return InternalServerError(ex);
        }
    }

    public class VoDebitDto { public int charsVo { get; set; } }

    // DEBIT detik VO (dipanggil setelah file audio berhasil dibuat)
    [HttpPost, Route("{license}/vo/debit")]
    public IHttpActionResult DebitVo(string license, [FromBody] VoDebitDto dto)
    {
        if (dto == null || dto.charsVo <= 0) return BadRequest("secondsUsed must be > 0");

        try
        {
            var cs = System.Configuration.ConfigurationManager
                       .ConnectionStrings["MaximalCuanLicenseDBConnectionString"].ConnectionString;

            using (var ctx = new MaximalCuanDataContext(cs))
            {
                var lic = ctx.Licenses.SingleOrDefault(x => x.LicenseKey == license);
                if (lic == null) return NotFound();

                var current = lic.VoSecondsRemaining;
                if (current <= 0)
                {
                    return Content((System.Net.HttpStatusCode)402, new
                    {
                        ok = false,
                        license,
                        message = "VO credit empty",
                        seconds_remaining = 0
                    });
                }

                var debit = Math.Min(current, dto.charsVo);
                lic.VoSecondsRemaining = current - debit;
                ctx.SubmitChanges();

                var remain = lic.VoSecondsRemaining;
                return Ok(new
                {
                    ok = true,
                    license,
                    seconds_debited = debit,
                    seconds_remaining = remain,
                    minutes_remaining = (int)Math.Ceiling(remain / 60.0)
                });
            }
        }
        catch (Exception ex)
        {
            LogError("DebitVo failed", ex);
            return InternalServerError(ex);
        }
    }

    // GET api/voice/{license}/vo/status
    [HttpGet, Route("{license}/vo/status")]
    public IHttpActionResult GetVoStatus(string license)
    {
        var cs = System.Configuration.ConfigurationManager
                    .ConnectionStrings["MaximalCuanLicenseDBConnectionString"].ConnectionString;

        using (var ctx = new MaximalCuanDataContext(cs))
        {
            var lic = ctx.Licenses.SingleOrDefault(x => x.LicenseKey == license);
            if (lic == null) return NotFound();

            return Ok(new
            {
                ok = true,
                license,
                seconds_remaining = lic.VoSecondsRemaining
            });
        }
    }

}

// DTOs
public class UpdateLicenseDto
{
    public string OrderId { get; set; }
    public string Owner { get; set; }
    public string Email { get; set; }
    public string Phone { get; set; }
    public string Edition { get; set; }
    public string PaymentStatus { get; set; }
    public string ProductName { get; set; }
    public int? TenorDays { get; set; }
    public int? MaxSeats { get; set; }
    public int? MaxVideo { get; set; }
    public string Features { get; set; }
    public string Status { get; set; }
    public bool? IsActivated { get; set; }
    public bool? Activated { get; set; }
    public DateTime? ActivationDateUtc { get; set; }
    public DateTime? ExpiresAt { get; set; }
    public DateTime? ExpiresAtUtc { get; set; }
    public string MachineId { get; set; }
    public string LicenseKey { get; set; }
    public int? VoSecondsRemaining { get; set; } // LIFETIME QUOTA (detik)
}

public class CreateLicenseDto
{
    public string OrderId { get; set; }
    public string Owner { get; set; }
    public string Email { get; set; }
    public string Phone { get; set; }
    public string Edition { get; set; }
    public string PaymentStatus { get; set; }
    public string ProductName { get; set; }
    public int? TenorDays { get; set; }
    public int? MaxSeats { get; set; }
    public int? MaxVideo { get; set; }
    public string Features { get; set; }
    public string Status { get; set; }
    public bool? IsActivated { get; set; }
    public DateTime? ExpiresAt { get; set; }
    public DateTime? ExpiresAtUtc { get; set; }
    public string MachineId { get; set; }
    public int? VoSecondsRemaining { get; set; } // LIFETIME QUOTA (detik)
}

// DTO untuk response
public class VoiceApiConfigDto
{
    public string Provider { get; set; }        // "Gemini" atau "OpenAI"
    public string ApiKey { get; set; }          // kembalikan kalau memang mau dipakai di client
    public string DefaultVoiceId { get; set; }
    public int SecondsRemaining { get; set; }
}

[RoutePrefix("api/voice")]   // <â€” tambahkan prefix yang stabil
public class VoiceController :ApiController
{
    private static void LogError(string message, Exception ex)
    {
        try
        {
            var path = HostingEnvironment.MapPath("~/App_Data/errors.log");
            var line = $"{DateTime.UtcNow:u} [{message}] {ex}\r\n";
            File.AppendAllText(path, line);
        }
        catch { }
    }


    [HttpGet, Route("{license}/voice-config")]
    public IHttpActionResult GetVoiceConfig(string license)
    {
        try
        {
            var cs = System.Configuration.ConfigurationManager
                       .ConnectionStrings["MaximalCuanLicenseDBConnectionString"].ConnectionString;

            using (var ctx = new MaximalCuanDataContext(cs))
            {
                // Cek license
                var lic = ctx.Licenses.SingleOrDefault(x => x.LicenseKey == license);
                if (lic == null) return NotFound();

                // Kalau quota habis
                if (lic.VoSecondsRemaining <= 0)
                {
                    return Content((System.Net.HttpStatusCode)402, new
                    {
                        ok = false,
                        license,
                        message = "Silakan topup dulu"
                    });
                }

                // Ambil semua API key dari ConfigApiKey
                var apikeys = ctx.ConfigApiKeys
                  .Where(x => x.Status == "AVAILABLE" && x.ApiKey != null && x.ApiKey != "")
                  .OrderByDescending(x => x.UpdatedAt)
                  .Select(x => new VoiceApiConfigDto
                  {
                      Provider = x.JenisApiKey,
                      ApiKey = x.ApiKey,
                      DefaultVoiceId = x.DefaultVoiceId,
                      SecondsRemaining = lic.VoSecondsRemaining
                  }).ToList();

                return Ok(new
                {
                    ok = true,
                    license,
                    seconds_remaining = lic.VoSecondsRemaining,
                    apikeys
                });
            }
        }
        catch (Exception ex)
        {
            LogError("GetVoiceConfig failed", ex);
            return InternalServerError(ex);
        }
    }
